---
kind: pipeline
type: docker
name: docker-jamserver amd64

platform:
  os: linux
  arch: amd64

environment:
  DOCKER_BUILDKIT: 1
  MAKEFLAGS: "-j4"

volumes:
  - name: repo
    temp: {}

steps:
  - name: Fetch submodules
    image: alpine/git
    commands:
      - git submodule update --init --recursive
  - name: Build ninjam apk
    image: alpinelinux/build-base
    volumes:
      - name: repo
        path: /repo
    environment:
      REPODEST: /repo
    commands:
      - abuild-keygen -nai
      - cp -r apkbuilds/packages/ninjam-server ~/; cd ~/ninjam-server
      - abuild -r
      - find /repo/
  - name: Build cbix/ninjam
    image: plugins/docker
    volumes:
      - name: repo
        path: /drone/src/repo
    settings:
      repo: cbix/ninjam
      tags: latest
      dockerfile: ninjam/Dockerfile
      username: cbix
      password:
        from_secret: docker-pass

trigger:
  event:
    - push
    - pull_request
    - cron
  branch:
    - master
  cron:
    - ""
    - docker
